<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christian Enz (christian.enz@epfl.ch)">
<meta name="dcterms.date" content="2025-08-28">

<title>Common-source Stage Optimization using the Inversion Coefficient</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="CS_CL_optimization_files/libs/clipboard/clipboard.min.js"></script>
<script src="CS_CL_optimization_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="CS_CL_optimization_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="CS_CL_optimization_files/libs/quarto-html/popper.min.js"></script>
<script src="CS_CL_optimization_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CS_CL_optimization_files/libs/quarto-html/anchor.min.js"></script>
<link href="CS_CL_optimization_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CS_CL_optimization_files/libs/quarto-html/quarto-syntax-highlighting-236d90495073fb2ac8939117e3e83141.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CS_CL_optimization_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CS_CL_optimization_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CS_CL_optimization_files/libs/bootstrap/bootstrap-de3a1749c61124d0c7456a0612b16043.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script>

  MathJax = {

    tex: {

      tags: 'ams'  // should be 'ams', 'none', or 'all'

    }

  };

</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis"><span class="header-section-number">2</span> Analysis</a>
  <ul class="collapse">
  <li><a href="#small-signal-transfer-function" id="toc-small-signal-transfer-function" class="nav-link" data-scroll-target="#small-signal-transfer-function"><span class="header-section-number">2.1</span> Small-signal Transfer Function</a></li>
  <li><a href="#minimum-current-for-a-given-bandwidth-long-channel" id="toc-minimum-current-for-a-given-bandwidth-long-channel" class="nav-link" data-scroll-target="#minimum-current-for-a-given-bandwidth-long-channel"><span class="header-section-number">2.2</span> Minimum current for a given bandwidth (long-channel)</a></li>
  </ul></li>
  <li><a href="#design-example" id="toc-design-example" class="nav-link" data-scroll-target="#design-example"><span class="header-section-number">3</span> Design Example</a>
  <ul class="collapse">
  <li><a href="#process" id="toc-process" class="nav-link" data-scroll-target="#process"><span class="header-section-number">3.1</span> Process</a></li>
  <li><a href="#simulation-results-from-ngspice" id="toc-simulation-results-from-ngspice" class="nav-link" data-scroll-target="#simulation-results-from-ngspice"><span class="header-section-number">3.2</span> Simulation results from ngspice</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">4</span> Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">5</span> References</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="CS_CL_optimization.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Common-source Stage Optimization using the Inversion Coefficient</h1>
<p class="subtitle lead">In Closed-loop Configuration (Version 1)</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christian Enz (christian.enz@epfl.ch) </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 28, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<div id="fig-CS_CL_amplifier_schematic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-CS_CL_amplifier_schematic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Figures/CS_CL_amplifier_schematic.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-CS_CL_amplifier_schematic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Schematic of the common-source switched-capacitor amplifier.
</figcaption>
</figure>
</div>
<p>In this notebook, we want to minimize the bias current of the common-source (CS) closed-loop (CL) amplifier of <a href="#fig-CS_CL_amplifier_schematic" class="quarto-xref">Figure&nbsp;1</a> for achieving a given gain and bandwidth.</p>
</section>
<section id="analysis" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Analysis</h1>
<section id="small-signal-transfer-function" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="small-signal-transfer-function"><span class="header-section-number">2.1</span> Small-signal Transfer Function</h2>
<div id="fig-small-signal_schematic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-small-signal_schematic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Figures/Small-signal_schematic.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-small-signal_schematic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Small-signal schematic of the CS SC amplifier.
</figcaption>
</figure>
</div>
<p>The small-signal schematic of the closed-loop common-source stage is shown in <a href="#fig-small-signal_schematic" class="quarto-xref">Figure&nbsp;2</a>. Notice that we added the input capacitance <span class="math inline">\(C_{in}\)</span> which essentially corresponds to the transistor gate-to-source and gate-to-bulk capacitances. The gate-to-drain capacitance is included in <span class="math inline">\(C_F\)</span> and therefore needs to be de-embedded in the design. It is easy to show that the transfer function is given by <span class="math display">\[\begin{equation}
  A(s) \triangleq \frac{\Delta V_{out}}{\Delta V_{in}} = A_0 \cdot \frac{1-s/\omega_z}{1+s/\omega_p}
\end{equation}\]</span> where <span class="math display">\[\begin{align}
  A_0 &amp;= A_{0,ideal} \cdot \frac{\beta \cdot A_{dc}}{1 + \beta \cdot A_{dc}} \cong A_{0,ideal}\quad\text{for $A_{dc} \gg 1$},\\
  A_{0,ideal} &amp;= -\frac{C_S}{C_F},\\
  \omega_p &amp;= \frac{1+\beta \cdot A_{dc}}{R_{ds} \cdot C_{out}} \cong \frac{\beta \cdot A_{dc}}{R_{ds} \cdot C_{out}} = \frac{\beta \cdot G_m}{C_{out}},\\
  \omega_z &amp;= \frac{G_m}{C_F}.
\end{align}\]</span></p>
<div id="fig-feedback_gain" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-feedback_gain-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Figures/Feedback_gain.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-feedback_gain-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Small-signal circuit to evaluate the feedback gain <span class="math inline">\(\beta\)</span>.
</figcaption>
</figure>
</div>
<p><span class="math inline">\(A_{dc} = G_m \cdot R_{ds}\)</span> is the CS transistor DC voltage gain, <span class="math inline">\(\beta \cdot A_{dc}\)</span> the DC loop gain where <span class="math inline">\(\beta\)</span> is the feedback gain which can be calculated from the schematic shown <a href="#fig-feedback_gain" class="quarto-xref">Figure&nbsp;3</a> as <span class="math display">\[\begin{equation}
  \beta \triangleq \frac{V}{V_{out}} = \frac{C_F}{C_F + C_S + C_{in}}.
\end{equation}\]</span></p>
<p>The amplifier bandwidth is given by <span class="math inline">\(\omega_c = \omega_p \cong \beta \cdot G_m/C_{out}\)</span> where <span class="math inline">\(C_{out}\)</span> is the total capacitance seen at the output <span class="math display">\[\begin{equation}
  C_{out} = C_L + (1-\beta) \cdot C_F = C_L + \frac{C_S + C_{in}}{C_F + C_S + C_{in}} \cdot C_F.
\end{equation}\]</span></p>
<div id="fig-transfer_function" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-transfer_function-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Figures/Transfer_function.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-transfer_function-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Small-signal transfer function of the CL CS amplifier.
</figcaption>
</figure>
</div>
<p>In order to achieve some DC gain <span class="math inline">\(C_F\)</span> is smaller than <span class="math inline">\(C_S\)</span> and usually also smaller than <span class="math inline">\(C_L\)</span>. This means that the right-hand side (RHS) zero is located higher than the unity gain frequency which is then simply given by <span class="math inline">\(\omega_u \cong G_m/C_{out}\)</span>. For frequencies below <span class="math inline">\(\omega_u\)</span>, the magnitude of the transfer function is shown in <a href="#fig-transfer_function" class="quarto-xref">Figure&nbsp;4</a>.</p>
</section>
<section id="minimum-current-for-a-given-bandwidth-long-channel" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="minimum-current-for-a-given-bandwidth-long-channel"><span class="header-section-number">2.2</span> Minimum current for a given bandwidth (long-channel)</h2>
<p>When optimizing the CL CS amplifier for low current consumption, the transistor is often biased in moderate or even weak inversion leading to large transistor and therefore an increased input and output capacitance. If we assume that the transistor parasitic capacitance at the drain is much smaller than the load capacitance, we can model this input capacitance as the sum of the gate-to-source and gate-to-bulk capacitances <span class="math display">\[\begin{equation}
  C_{in} = C_{GS} + C_{GB}.
\end{equation}\]</span> Assuming transistor is biased in saturation, we have <span class="math display">\[\begin{equation}
  C_{GS} \cong W\,L\,C_{ox} \cdot c_{gsi} + C_{GSo} \cdot W
\end{equation}\]</span> where <span class="math inline">\(c_{gsi}\)</span> is the normalized intrinsic gate-to-source capacitance which is typically equal to <span class="math inline">\(2/3\)</span> in strong inversion and is proportionnal to <span class="math inline">\(IC\)</span> in weak inversion. <span class="math inline">\(C_{GSo}\)</span> is the gate-to-source overlap capacitance per unit width.</p>
<p>The gate-to-bulk capacitance <span class="math inline">\(C_{GB}\)</span> is given by <span class="math display">\[\begin{equation}
  C_{GB} \cong \,W\,L\,C_{ox} \cdot c_{gbi} + C_{GBo} \cdot W,
\end{equation}\]</span> where <span class="math inline">\(c_{gbi}\)</span> is the normalized gate-to-bulk intrinsic capacitance which in strong inversion is given by <span class="math display">\[\begin{equation}
  c_{gbi} = \frac{n-1}{3n}.
\end{equation}\]</span> <span class="math inline">\(C_{GBo}\)</span> is the gate-to-bulk overlap capacitance per unit width.</p>
<p>For a given transistor length <span class="math inline">\(L\)</span>, the input capacitance <span class="math inline">\(C_{in}\)</span> scales with <span class="math inline">\(W\)</span> according to <span class="math display">\[\begin{equation}
  C_{in} = C_{GW} \cdot W,
\end{equation}\]</span> where <span class="math inline">\(C_{GW}\)</span> is the gate-to-source and gate-to-bulk capacitance per unit width given by <span class="math display">\[\begin{equation}
  C_{GW} = L\,C_{ox} \cdot (c_{gsi} + c_{gbi}) + C_{GSo}  + C_{GBo}.
\end{equation}\]</span></p>
<p>In order to achieve a certain bandwidth we need to have a certain transconductance for a certain load capacitance. In order to maximize the current efficiency, we should bias the transistor in weak inversion. This leads to a large transistor and therefore large parasitic capacitances which will impact the bandwidth. Imposing the bandwidth, at some point the capacitance becomes so large that it is no more possible to achieve the required transconductance in weak inversion for the desired bandwidth. Does this mean that there is a minimum current for the CL CS amplifier to achieve a certain bandwidth?</p>
<p>To answer this question we need to solve the following set of equations for <span class="math inline">\(I_b\)</span> and <span class="math inline">\(W\)</span> assuming a given length <span class="math inline">\(L\)</span> <span class="math display">\[\begin{align}
  \omega_c &amp;= \beta \cdot \frac{G_m}{C_{out}},\\
  C_{out} &amp;= C_L + (1-\beta) \cdot C_F,\\
  \beta &amp;= \frac{C_F}{C_F + C_S + C_{in}},\\
  C_{in} &amp;= W \cdot C_{GW},\\
  I_b &amp;= I_{spec\Box} \cdot \frac{W}{L} \cdot IC,\\
  G_m &amp;= \frac{I_{spec\Box}}{n U_T} \cdot \frac{W}{L} \cdot g_{ms}(IC),
\end{align}\]</span> where <span class="math inline">\(g_{ms}(IC)\)</span> is the long-channel normalized source transconductance given by <span class="math display">\[\begin{equation}
  g_{ms} = \frac{\sqrt{4 IC + 1} - 1}{2} = \frac{2 IC}{\sqrt{4 IC + 1} + 1}.
\end{equation}\]</span> Solving for <span class="math inline">\(I_b\)</span> and <span class="math inline">\(W/L\)</span> leads to the following normalized solutions <span class="math display">\[\begin{align}\label{eq:ib_AR}
  i_b &amp;\triangleq \frac{I_b}{I_{spec\Box} \cdot \Omega} = \frac{IC}{g_{ms}(IC) - \Theta},\\
  AR &amp;\triangleq \frac{W/L}{\Omega} =\frac{1}{g_{ms} - \Theta},
\end{align}\]</span> where <span class="math display">\[\begin{align}
  \Omega &amp;\triangleq \frac{\omega_c}{\omega_L},\\
  \omega_L &amp;\triangleq \frac{I_{spec\Box}}{n U_T} \cdot \frac{1}{(1+C_S/C_L+C_S/C_F) \cdot C_L},\\
  \Theta &amp;\triangleq \frac{\omega_c}{\omega_W},\\
  \omega_W &amp;\triangleq \frac{I_{spec\Box}}{n U_T} \cdot \frac{1}{(1+C_L/C_F) \cdot C_{GW} \cdot L}.
\end{align}\]</span></p>
<p>The normalized current <span class="math inline">\(i_b\)</span> is plotted below for different values of <span class="math inline">\(\Theta\)</span>.</p>
<div id="cell-fig-ib_vs_ic" class="cell" data-execution_count="2">
<div class="cell-output cell-output-display">
<div id="fig-ib_vs_ic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ib_vs_ic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CS_CL_optimization_files/figure-html/fig-ib_vs_ic-output-1.png" width="464" height="296" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ib_vs_ic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Normalized bias current <span class="math inline">\(i_b\)</span> versus inversion coefficient <span class="math inline">\(IC\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>From <a href="#fig-ib_vs_ic" class="quarto-xref">Figure&nbsp;5</a>, we clearly see that there is a minimum current for a given value of parameter <span class="math inline">\(\Theta\)</span>. We can find the optimum inversion coefficient <span class="math inline">\(IC_{opt}\)</span> which is given by <span class="math display">\[\begin{align}
  IC_{opt} &amp;= \left(\sqrt{\Theta \cdot (1+\Theta)} + \Theta + \frac{1}{2}\right)^2 - \frac{1}{4}\\
  &amp;= 2 \Theta \cdot (1+\Theta) + (1+2\Theta) \cdot \sqrt{\Theta \cdot (1+\Theta)}\\
  &amp;\cong 2 \Theta + \sqrt{\Theta} \;\; \textsf{for $\Theta \ll 1$}.
\end{align}\]</span> We also see that there is a minimum inversion coefficient <span class="math inline">\(IC_{lim}\)</span> below which the desired bandwidth <span class="math inline">\(\omega_c\)</span> can no more be achieved <span class="math display">\[\begin{equation}
  IC_{lim} = \Theta \cdot (1+\Theta) \cong \Theta,
\end{equation}\]</span> which is about equal to <span class="math inline">\(\Theta\)</span> for small values of <span class="math inline">\(\Theta\)</span>.</p>
<p>The optimum normalized current is given by <span class="math display">\[\begin{equation}
  i_{bopt} \triangleq i_b(IC_{opt}) = 1 + 2\Theta +2\sqrt{\Theta \cdot (1+\Theta)}.
\end{equation}\]</span></p>
<p>The optimum current also corresponds an optimum transistor width <span class="math inline">\(W\)</span> and hence and optimum normalized <span class="math inline">\(W/L\)</span> given by <span class="math display">\[\begin{equation}
  AR_{opt} \triangleq AR(IC_{opt}) = \frac{1}{\sqrt{\Theta \cdot (1+\Theta)}}.
\end{equation}\]</span></p>
<div id="cell-fig-woverl_vs_ic" class="cell" data-execution_count="3">
<div class="cell-output cell-output-display">
<div id="fig-woverl_vs_ic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-woverl_vs_ic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CS_CL_optimization_files/figure-html/fig-woverl_vs_ic-output-1.png" width="465" height="296" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-woverl_vs_ic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Normalized aspect ratio <span class="math inline">\(W/L\)</span> versus inversion coefficient <span class="math inline">\(IC\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We see from <a href="#fig-woverl_vs_ic" class="quarto-xref">Figure&nbsp;6</a> that the transistor width increases first as <span class="math inline">\(1/\sqrt{IC}\)</span> in strong inversion and then as <span class="math inline">\(1/IC\)</span> in weak inversion making the transistor quickly very large until <span class="math inline">\(IC\)</span> reaches <span class="math inline">\(IC_{lim}\)</span> where the width becomes infinity. The dots correspond to the <span class="math inline">\(AR\)</span> obtained for <span class="math inline">\(IC_{opt}\)</span>.</p>
</section>
</section>
<section id="design-example" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Design Example</h1>
<div id="fig-example_schematic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-example_schematic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Figures/Example_schematic.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-example_schematic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Schematic of the CS SC amplifier used for simulations.
</figcaption>
</figure>
</div>
<p>We want to size a CS SC amplifier for the specifications given in <a href="#tbl-specs" class="quarto-xref">Table&nbsp;1</a>. We need to find the minimum current and size the transistor to achieve this specs. We will design the amplifier for a generic 180nm bulk CMOS process. The physical parameters are given in <a href="#tbl-physics_param" class="quarto-xref">Table&nbsp;2</a>, the global process parameters in <a href="#tbl-process_param" class="quarto-xref">Table&nbsp;3</a> and finally the MOSFET parameters in <a href="#tbl-mos_param" class="quarto-xref">Table&nbsp;4</a>.</p>
<p>Note that the feedback resistor <span class="math inline">\(R_F\)</span> in <a href="#fig-example_schematic" class="quarto-xref">Figure&nbsp;7</a> has been added for biasing purpose and should be taken large enough not to limit the gain and bandwidth. The cut-off frequency due to <span class="math inline">\(R_F\)</span> is given by <span class="math display">\[\begin{equation}
  \omega_l = \frac{A_0}{R_F \cdot C_S}
\end{equation}\]</span> from which we deduce the value of <span class="math inline">\(R_F\)</span> <span class="math display">\[\begin{equation}
  R_F = \frac{A_0}{\omega_l \cdot C_S}.
\end{equation}\]</span> We will set <span class="math inline">\(f_l\)</span> to 1 Hz.</p>
<div class="cell" data-execution_count="4">
<div id="tbl-specs" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="4">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-specs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: CS SC amplifier specifications.
</figcaption>
<div aria-describedby="tbl-specs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="22">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Specification</th>
<th style="text-align: center;">Symbol</th>
<th style="text-align: center;">Value</th>
<th style="text-align: center;">Unit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">DC gain</td>
<td style="text-align: center;"><span class="math inline">\(A_0\)</span></td>
<td style="text-align: center;">20</td>
<td style="text-align: center;"><span class="math inline">\(dB\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">Bandwidth</td>
<td style="text-align: center;"><span class="math inline">\(BW\)</span></td>
<td style="text-align: center;">100</td>
<td style="text-align: center;"><span class="math inline">\(kHz\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Load capacitance</td>
<td style="text-align: center;"><span class="math inline">\(C_L\)</span></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;"><span class="math inline">\(pF\)</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">Feedback capacitance</td>
<td style="text-align: center;"><span class="math inline">\(C_F\)</span></td>
<td style="text-align: center;">100</td>
<td style="text-align: center;"><span class="math inline">\(fF\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Transistor length</td>
<td style="text-align: center;"><span class="math inline">\(L\)</span></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;"><span class="math inline">\(\mu m\)</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<section id="process" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="process"><span class="header-section-number">3.1</span> Process</h2>
<p>We will design the CS CL amplifier for generic 180nm bulk CMOS process. The physical parameters are given in <a href="#tbl-physics_param" class="quarto-xref">Table&nbsp;2</a>, the global process parameters in <a href="#tbl-process_param" class="quarto-xref">Table&nbsp;3</a> and finally the MOSFET parameters in <a href="#tbl-mos_param" class="quarto-xref">Table&nbsp;4</a>.</p>
<div class="cell" data-execution_count="5">
<div id="tbl-physics_param" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="5">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-physics_param-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Physical parameters
</figcaption>
<div aria-describedby="tbl-physics_param-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="23">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Parameter</th>
<th style="text-align: center;">Value</th>
<th style="text-align: center;">Unit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(T\)</span></td>
<td style="text-align: center;">300</td>
<td style="text-align: center;"><span class="math inline">\(K\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(U_T\)</span></td>
<td style="text-align: center;">25.875</td>
<td style="text-align: center;"><span class="math inline">\(mV\)</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-execution_count="6">
<div id="tbl-process_param" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="6">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-process_param-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Global process parameters
</figcaption>
<div aria-describedby="tbl-process_param-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="24">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Parameter</th>
<th style="text-align: center;">Value</th>
<th style="text-align: center;">Unit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(V_{DD}\)</span></td>
<td style="text-align: center;">1.8</td>
<td style="text-align: center;"><span class="math inline">\(V\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(C_{ox}\)</span></td>
<td style="text-align: center;">8.443</td>
<td style="text-align: center;"><span class="math inline">\(\frac{fF}{\mu m^2}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(W_{min}\)</span></td>
<td style="text-align: center;">200</td>
<td style="text-align: center;"><span class="math inline">\(nm\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(L_{min}\)</span></td>
<td style="text-align: center;">180</td>
<td style="text-align: center;"><span class="math inline">\(nm\)</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-execution_count="7">
<div id="tbl-mos_param" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="7">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-mos_param-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Transistor process parameters
</figcaption>
<div aria-describedby="tbl-mos_param-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="25">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Parameter</th>
<th style="text-align: center;">NMOS</th>
<th style="text-align: center;">PMOS</th>
<th style="text-align: center;">Unit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">sEKV parameters</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(n\)</span></td>
<td style="text-align: center;">1.27</td>
<td style="text-align: center;">1.31</td>
<td style="text-align: center;">-</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(I_{{spec\Box}}\)</span></td>
<td style="text-align: center;">715</td>
<td style="text-align: center;">173</td>
<td style="text-align: center;"><span class="math inline">\(nA\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(V_{{T0}}\)</span></td>
<td style="text-align: center;">0.455</td>
<td style="text-align: center;">0.445</td>
<td style="text-align: center;"><span class="math inline">\(V\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(L_{{sat}}\)</span></td>
<td style="text-align: center;">26</td>
<td style="text-align: center;">36</td>
<td style="text-align: center;"><span class="math inline">\(nm\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\lambda\)</span></td>
<td style="text-align: center;">20</td>
<td style="text-align: center;">20</td>
<td style="text-align: center;"><span class="math inline">\(\frac{{V}}{{\mu m}}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Overlap capacitances parameters</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(C_{{GDo}}\)</span></td>
<td style="text-align: center;">0.366</td>
<td style="text-align: center;">0.329</td>
<td style="text-align: center;"><span class="math inline">\(\frac{{fF}}{{\mu m}}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(C_{{GSo}}\)</span></td>
<td style="text-align: center;">0.366</td>
<td style="text-align: center;">0.329</td>
<td style="text-align: center;"><span class="math inline">\(\frac{{fF}}{{\mu m}}\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(C_{{GBo}}\)</span></td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;"><span class="math inline">\(\frac{{fF}}{{\mu m}}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Junction capacitances parameters</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(C_J\)</span></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1.121</td>
<td style="text-align: center;"><span class="math inline">\(\frac{{fF}}{{\mu m^2}}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(C_{{JSW}}\)</span></td>
<td style="text-align: center;">0.2</td>
<td style="text-align: center;">0.248</td>
<td style="text-align: center;"><span class="math inline">\(\frac{{fF}}{{\mu m}}\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;">Flicker noise parameters</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(K_F\)</span></td>
<td style="text-align: center;">8.1e-24</td>
<td style="text-align: center;">8.1e-24</td>
<td style="text-align: center;"><span class="math inline">\(J\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(AF\)</span></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">-</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\rho\)</span></td>
<td style="text-align: center;">0.05794</td>
<td style="text-align: center;">0.4828</td>
<td style="text-align: center;"><span class="math inline">\(\frac{{V \cdot m^2}}{{A \cdot s}}\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;">Matching parameters</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(A_{{VT}}\)</span></td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;"><span class="math inline">\(mV \cdot \mu m\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(A_{{\beta}}\)</span></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;"><span class="math inline">\(\% \cdot \mu m\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Source and drain sheet resistance parameter</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(R_{{sh}}\)</span></td>
<td style="text-align: center;">600</td>
<td style="text-align: center;">2386</td>
<td style="text-align: center;"><span class="math inline">\(\frac{{\Omega}}{{\mu m}}\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Width and length parameters</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\Delta W\)</span></td>
<td style="text-align: center;">39</td>
<td style="text-align: center;">54</td>
<td style="text-align: center;"><span class="math inline">\(\,nm\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\Delta L\)</span></td>
<td style="text-align: center;">-76</td>
<td style="text-align: center;">-72</td>
<td style="text-align: center;"><span class="math inline">\(\,nm\)</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>We first need to estimate the parameter <span class="math inline">\(C_{GW}\)</span> which is related to the transistor input capacitance <span class="math inline">\(C_{in}\)</span>. Since we don’t know the inversion coefficient we cannot estimate <span class="math inline">\(c_{gsi}\)</span> and <span class="math inline">\(c_{gbi}\)</span>. We therefore will take their values in strong inversion for the estimation of the input capacitance per width <span class="math inline">\(C_{GW}\)</span> <span class="math display">\[\begin{equation}
  C_{GW} \cong \left(1-\frac{1}{3 n}\right) \cdot C_{ox} \cdot L + C_{GSo} + C_{GBo},
\end{equation}\]</span> which depends on transistor length <span class="math inline">\(L\)</span>. Since the above theory was developed for a long-channel device, we will choose <span class="math inline">\(L =\)</span> 1 <span class="math inline">\(\mu m\)</span>.. We can now estimate the total gate capacitance per unit width for an n-channel transistor.</p>
<p>For the selected technology, we get <span class="math inline">\(C_{GW} =\)</span> 6.596 <span class="math inline">\(fF/\mu m\)</span>.</p>
<p>From the DC gain specification <span class="math inline">\(A_0 =\)</span> 10, we get <span class="math inline">\(C_S =\)</span> 1 <span class="math inline">\(pF\)</span>. We can compute the optimum inversion coefficient <span class="math inline">\(IC_{opt}\)</span>, optimum width <span class="math inline">\(W_{opt}\)</span>, optimum current <span class="math inline">\(I_{b,opt}\)</span> and aspect ratio <span class="math inline">\(\left.W/L\right|_{opt}\)</span> which are given in <a href="#tbl-optimum_parameters" class="quarto-xref">Table&nbsp;5</a>.</p>
<div class="cell" data-execution_count="9">
<div id="tbl-optimum_parameters" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="9">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-optimum_parameters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: CS SC amplifier optimum parameters.
</figcaption>
<div aria-describedby="tbl-optimum_parameters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="27">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Parameter</th>
<th style="text-align: center;">Value</th>
<th style="text-align: center;">Unit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(A_0\)</span></td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">-</td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(C_S\)</span></td>
<td style="text-align: center;">1</td>
<td style="text-align: center;"><span class="math inline">\(pF\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(f_L\)</span></td>
<td style="text-align: center;">288.269</td>
<td style="text-align: center;"><span class="math inline">\(kHz\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(f_W\)</span></td>
<td style="text-align: center;">47.679</td>
<td style="text-align: center;"><span class="math inline">\(MHz\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\Omega\)</span></td>
<td style="text-align: center;">0.347</td>
<td style="text-align: center;">-</td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\theta\)</span></td>
<td style="text-align: center;">0.002097</td>
<td style="text-align: center;">-</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(IC_{opt}\)</span></td>
<td style="text-align: center;">0.05</td>
<td style="text-align: center;">-</td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(i_{b,opt}\)</span></td>
<td style="text-align: center;">1.096</td>
<td style="text-align: center;">-</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(AR_{opt}\)</span></td>
<td style="text-align: center;">21.813</td>
<td style="text-align: center;">-</td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\left(\frac{W}{L}\right)_{opt}\)</span></td>
<td style="text-align: center;">7.567</td>
<td style="text-align: center;">-</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(I_{b,opt}\)</span></td>
<td style="text-align: center;">272</td>
<td style="text-align: center;"><span class="math inline">\(nA\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(W_{opt}\)</span></td>
<td style="text-align: center;">7.57</td>
<td style="text-align: center;"><span class="math inline">\(\mu m\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(C_{in}\)</span></td>
<td style="text-align: center;">49.908</td>
<td style="text-align: center;"><span class="math inline">\(fF\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(C_{GD}\)</span></td>
<td style="text-align: center;">2.773</td>
<td style="text-align: center;"><span class="math inline">\(fF\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(C_F\)</span></td>
<td style="text-align: center;">100</td>
<td style="text-align: center;"><span class="math inline">\(fF\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(C_{F0}\)</span></td>
<td style="text-align: center;">97.227</td>
<td style="text-align: center;"><span class="math inline">\(fF\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(R_F\)</span></td>
<td style="text-align: center;">0.159</td>
<td style="text-align: center;"><span class="math inline">\(T \Omega\)</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-execution_count="10">
<div id="tbl-transistor_info1" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="10">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-transistor_info1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Transistor size and bias information.
</figcaption>
<div aria-describedby="tbl-transistor_info1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="28">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Transistor</th>
<th style="text-align: center;"><span class="math inline">\(W\;[\mu m]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(L\;[\mu m]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(I_D\;[nA]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(I_{{spec}}\;[nA]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(IC\)</span></th>
<th style="text-align: center;"><span class="math inline">\(V_G-V_{{T0}}\;[mV]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(V_{{DSsat}}\;[mV]\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">M1</td>
<td style="text-align: center;">7.57</td>
<td style="text-align: center;">1.00</td>
<td style="text-align: center;">272</td>
<td style="text-align: center;">5410</td>
<td style="text-align: center;">0.050</td>
<td style="text-align: center;">-60</td>
<td style="text-align: center;">104</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-execution_count="11">
<div id="tbl-transistor_info2" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="11">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-transistor_info2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7: Transistor small-signal and thermal noise parameters.
</figcaption>
<div aria-describedby="tbl-transistor_info2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="29">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Transistor</th>
<th style="text-align: center;"><span class="math inline">\(G_{{spec}}\;[\mu A/V]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(G_{{ms}}\;[\mu A/V]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(G_m\;[\mu A/V]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(G_{{ds}}\;[nA/V]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(\gamma_n\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">M1</td>
<td style="text-align: center;">209.093</td>
<td style="text-align: center;">10.024</td>
<td style="text-align: center;">7.885</td>
<td style="text-align: center;">13.591</td>
<td style="text-align: center;">0.645</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The transistor size and bias information are given in <a href="#tbl-transistor_info1" class="quarto-xref">Table&nbsp;6</a>, while <a href="#tbl-transistor_info2" class="quarto-xref">Table&nbsp;7</a> gives the small-signal parameters.</p>
<div id="cell-fig-theoretical_tf" class="cell" data-execution_count="12">
<div class="cell-output cell-output-display">
<div id="fig-theoretical_tf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-theoretical_tf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CS_CL_optimization_files/figure-html/fig-theoretical_tf-output-1.png" width="634" height="441" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-theoretical_tf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Theoretical transfer function.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="simulation-results-from-ngspice" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="simulation-results-from-ngspice"><span class="header-section-number">3.2</span> Simulation results from ngspice</h2>
<p>The theoretical results can be validated by comparing them to the results obtained from simulations performed with ngspice. The cells below will run the simulations with ngspice. In order to run the simulations you need to have ngspice installed. Please refer to the ngspice instructions.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The simulations are performed with ngspice <span class="citation" data-cites="bib:ngspice:2024"><a href="#ref-bib:ngspice:2024" role="doc-biblioref">[1]</a></span> using the EKV 2.6 compact model <span class="citation" data-cites="bib:ekv2p6:doc:rev2:1998"><a href="#ref-bib:ekv2p6:doc:rev2:1998" role="doc-biblioref">[2]</a></span>. For ngspice, we use the original Verilog-A implementation of EKV 2.6 <span class="citation" data-cites="bib:grabinski:ekv2p6veriloga:essderc:2019"><a href="#ref-bib:grabinski:ekv2p6veriloga:essderc:2019" role="doc-biblioref">[3]</a></span> modified by C. Enz to get the operating point informations and available on the Gitub va-models site provided by D. Warning at <span class="citation" data-cites="bib:dwarning:2024"><a href="#ref-bib:dwarning:2024" role="doc-biblioref">[4]</a></span>. The parameters correspond to a generic 180 nm bulk CMOS process <span class="citation" data-cites="bib:grabinski:ekv2p6_param_extraction:mixdes:2015"><a href="#ref-bib:grabinski:ekv2p6_param_extraction:mixdes:2015" role="doc-biblioref">[5]</a></span>.</p>
</div>
</div>
<p>Before running the AC simulation, we first need to check the quiescent voltages and currents and the operating point by running an .OP simulation. The node voltages are extracted from the .ic file and presented in <a href="#tbl-op_voltages" class="quarto-xref">Table&nbsp;8</a>.</p>
<div class="cell" data-execution_count="13">
<div id="tbl-op_voltages" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="13">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-op_voltages-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;8: OTA node voltages with the OTA in open-loop without offset correction.
</figcaption>
<div aria-describedby="tbl-op_voltages-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="31">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Node</th>
<th style="text-align: center;">Voltage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">vdd</td>
<td style="text-align: center;">1.8</td>
</tr>
<tr class="even">
<td style="text-align: center;">in</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">g</td>
<td style="text-align: center;">0.382048</td>
</tr>
<tr class="even">
<td style="text-align: center;">out</td>
<td style="text-align: center;">0.382048</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-execution_count="14">
<div id="tbl-op1" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="14">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-op1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;9: PSP operating point information extracted from ngspice .op file for each transistor.
</figcaption>
<div aria-describedby="tbl-op1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="32">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Transistor</th>
<th style="text-align: center;"><span class="math inline">\(I_D\;[nA]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(I_{spec}\;[nA]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(IC\)</span></th>
<th style="text-align: center;"><span class="math inline">\(n\)</span></th>
<th style="text-align: center;"><span class="math inline">\(V_{Dsat}\;[mV]\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">M1</td>
<td style="text-align: center;">274</td>
<td style="text-align: center;">6034</td>
<td style="text-align: center;">0.045</td>
<td style="text-align: center;">1.27</td>
<td style="text-align: center;">114</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-execution_count="15">
<div id="tbl-op2" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="15">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-op2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;10: PSP small-signal operating point information extracted from ngspice .op file for each transistor.
</figcaption>
<div aria-describedby="tbl-op2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="33">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: center;">Transistor</th>
<th style="text-align: center;"><span class="math inline">\(n\)</span></th>
<th style="text-align: center;"><span class="math inline">\(G_{ms}\;[\mu A/V]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(G_m\;[\mu A/V]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(G_{mb}\;[\mu A/V]\)</span></th>
<th style="text-align: center;"><span class="math inline">\(G_{ds}\;[nA/V]\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">M1</td>
<td style="text-align: center;">1.27</td>
<td style="text-align: center;">10.145</td>
<td style="text-align: center;">7.835</td>
<td style="text-align: center;">2.292</td>
<td style="text-align: center;">17.705</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The large-signal transistor bias information and the small-signal parameters extracted from the simulation are given in <a href="#tbl-op1" class="quarto-xref">Table&nbsp;9</a> and <a href="#tbl-op2" class="quarto-xref">Table&nbsp;10</a>, respectively. We see that their values are very close to the theoretical values given in <a href="#tbl-transistor_info1" class="quarto-xref">Table&nbsp;6</a> and <a href="#tbl-transistor_info2" class="quarto-xref">Table&nbsp;7</a>.</p>
<p>The simulated transfer function is shown in <a href="#fig-simulated_tf" class="quarto-xref">Figure&nbsp;9</a> and compared to the theoretical transfer function of <a href="#fig-transfer_function" class="quarto-xref">Figure&nbsp;4</a>. We see a perfect match between theory and simulation.</p>
<div id="cell-fig-simulated_tf" class="cell" data-execution_count="16">
<div class="cell-output cell-output-display">
<div id="fig-simulated_tf" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simulated_tf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CS_CL_optimization_files/figure-html/fig-simulated_tf-output-1.png" width="607" height="441" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simulated_tf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Simulated gain response compared to theoretical estimation.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Is this truly the minimum current?</p>
</div>
</div>
<p>We can check this by sweeping <span class="math inline">\(IC\)</span> and running a simulation for each of these point keeping the same specifications as in <a href="#tbl-specs" class="quarto-xref">Table&nbsp;1</a>. This leads to the family of transfer functions shown in <a href="#fig-tf_sweep_ic" class="quarto-xref">Figure&nbsp;10</a>. We see that all the simulations match the specification for different bias currents. The actual bias currents are plotted versus the inversion coefficient in <a href="#fig-ib_sweep_ic" class="quarto-xref">Figure&nbsp;11</a>. We see that the bias current is indeed minimum at the theoretical value extracted above.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We observe that the minimum is rather flat and therefore not too sensitive to the value of the optimum inversion coefficient.</p>
</div>
</div>
<div id="cell-fig-tf_sweep_ic" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display">
<div id="fig-tf_sweep_ic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tf_sweep_ic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CS_CL_optimization_files/figure-html/fig-tf_sweep_ic-output-1.png" width="565" height="441" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tf_sweep_ic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Simulated gain response for various values of the inversion coefficient <span class="math inline">\(IC\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-ib_sweep_ic" class="cell" data-execution_count="18">
<div class="cell-output cell-output-display">
<div id="fig-ib_sweep_ic" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ib_sweep_ic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="CS_CL_optimization_files/figure-html/fig-ib_sweep_ic-output-1.png" width="416" height="293" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ib_sweep_ic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Bias current <span class="math inline">\(I_b\)</span> versus inversion coefficient <span class="math inline">\(IC\)</span> corresponding to the transfer functions shown in <a href="#fig-tf_sweep_ic" class="quarto-xref">Figure&nbsp;10</a>.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Conclusion</h1>
<p>In this notebook we have optimized a single transistor SC amplifier for minimum power consumption. We started to analyze the circuit accounting for the input parasitic capacitance which scales with the width of the transistor. We have found that there is an optimum transistor inversion coefficient and width for achieving a certain bandwidth with a minimum bias current. We then illustrated the theory with an example. The sized circuit was then simulated with ngspice using the EKV 2.6 compact model for a generic 180nm CMOS technology. The simulation results perfectly match the theory.</p>
</section>
<section id="references" class="level1 unnumbered" data-number="5">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">5 References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="0" role="list">
<div id="ref-bib:ngspice:2024" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">Holger Vogt, Giles Atkinson, Paolo Nenzi, <span>“<span class="nocase">Ngspice User’s Manual Version 43</span>.”</span> <a href="https://ngspice.sourceforge.io/docs/ngspice-43-manual.pdf" class="uri">https://ngspice.sourceforge.io/docs/ngspice-43-manual.pdf</a>, 2024.</div>
</div>
<div id="ref-bib:ekv2p6:doc:rev2:1998" class="csl-entry" role="listitem">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">M. Bucher, C. Lallement, C. Enz, F. Théodoloz, and F. Krummenacher, <span>“<span class="nocase">The EPFL-EKV MOSFET Model Equations for Simulation</span>.”</span> <a href="https://github.com/chrisenz/EKV/blob/main/EKV2.6/docs/ekv_v26_rev2.pdf" class="uri">https://github.com/chrisenz/EKV/blob/main/EKV2.6/docs/ekv_v26_rev2.pdf</a>, 1998.</div>
</div>
<div id="ref-bib:grabinski:ekv2p6veriloga:essderc:2019" class="csl-entry" role="listitem">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">W. Grabinski <em>et al.</em>, <span>“FOSS EKV2.6 verilog-a compact MOSFET model,”</span> in <em>European solid-state device research conference (ESSDERC)</em>, 2019, pp. 190–193. doi: <a href="https://doi.org/10.1109/ESSDERC.2019.8901822">10.1109/ESSDERC.2019.8901822</a>.</div>
</div>
<div id="ref-bib:dwarning:2024" class="csl-entry" role="listitem">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">Dietmar Warning, <span>“<span class="nocase">Verilog-A Models for Circuit Simulation</span>.”</span> <a href="https://github.com/dwarning/VA-Models" class="uri">https://github.com/dwarning/VA-Models</a>, 2024.</div>
</div>
<div id="ref-bib:grabinski:ekv2p6_param_extraction:mixdes:2015" class="csl-entry" role="listitem">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline">W. Grabinski <em>et al.</em>, <span>“FOSS EKV 2.6 parameter extractor,”</span> in <em>2015 22nd international conference mixed design of integrated circuits &amp; systems (MIXDES)</em>, 2015, pp. 181–186. doi: <a href="https://doi.org/10.1109/MIXDES.2015.7208507">10.1109/MIXDES.2015.7208507</a>.</div>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>